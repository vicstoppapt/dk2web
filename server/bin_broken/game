#!/bin/sh
# Start Game Server

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
cd "$SCRIPT_DIR" || exit 1

LOG_FILE="gameserver_$(date '+%y%m%d_%H%M').out"
CONF_FILE="../conf/gameserver.conf"
BINARY="./gameserver"

# Check if binary exists
if [ ! -f "$BINARY" ]; then
    echo "Error: $BINARY not found in $(pwd)" >&2
    exit 1
fi

# Check if binary is executable
if [ ! -x "$BINARY" ]; then
    echo "Error: $BINARY is not executable" >&2
    exit 1
fi

# Check if config file exists
if [ ! -f "$CONF_FILE" ]; then
    echo "Warning: Config file $CONF_FILE not found" >&2
fi

# Check if already running
if pgrep -f "gameserver" > /dev/null 2>&1; then
    echo "Warning: Game server appears to be already running" >&2
fi

# Start the server
echo "Starting game server..."
echo "  Binary: $BINARY"
echo "  Config: $CONF_FILE"
echo "  Log: $LOG_FILE"

"$BINARY" -f "$CONF_FILE" > "$LOG_FILE" 2>&1 &
PID=$!

sleep 1

# Verify it started
if kill -0 "$PID" 2>/dev/null; then
    echo "✓ Game server started (PID: $PID)"
    echo "  Log file: $LOG_FILE"
else
    echo "✗ Failed to start game server" >&2
    echo "  Check log file: $LOG_FILE" >&2
    exit 1
fi
